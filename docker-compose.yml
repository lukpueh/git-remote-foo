version: "3"

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - git-server
      - log
    volumes:
      - test-dir:/tmp/foo
    stop_grace_period: 0s
    environment:
      FOO_LOG_FILE: /tmp/foo/log

  log:
    image: alpine:latest
    command: sh -c "mkdir -p /tmp/foo && > /tmp/foo/log && tail -f /tmp/foo/log"
    volumes:
      - test-dir:/tmp/foo
    stop_grace_period: 0s

  git-server:
    image: rockstorm/git-server
    container_name: git-server
    restart: unless-stopped

    environment:
      # Password for the git user
      GIT_PASSWORD: "hunter2"

      # Setting this variable creates a link in the git user directory
      # to access repositories without absolute paths
      REPOSITORIES_HOME_LINK: /srv/git

    volumes:
      - ./test:/srv/git
      # Configuration file for the OpenSSH daemon to use instead of
      # the one that is generated by default
      - ./sshd_config:/etc/ssh/sshd_config:ro
    ports:
      - "2222:22"

volumes:
  test-dir: